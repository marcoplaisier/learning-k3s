apiVersion: apps/v1
kind: Deployment
metadata:
  name: karavan
  namespace: karavan
  annotations:
    argocd.argoproj.io/sync-wave: "3"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: karavan
  template:
    metadata:
      labels:
        app: karavan
    spec:
      serviceAccountName: karavan
      containers:
      - name: karavan
        image: ghcr.io/apache/camel-karavan:4.10.2
        ports:
        - containerPort: 8080
          name: http
        env:
        - name: KARAVAN_ENVIRONMENT
          value: "kubernetes"
        - name: KARAVAN_GIT_REPOSITORY
          valueFrom:
            secretKeyRef:
              name: karavan-git
              key: karavan.git.repository
        - name: KARAVAN_GIT_USERNAME
          valueFrom:
            secretKeyRef:
              name: karavan-git
              key: karavan.git.username
        - name: KARAVAN_GIT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: karavan-git
              key: karavan.git.password
        - name: KARAVAN_GIT_BRANCH
          valueFrom:
            secretKeyRef:
              name: karavan-git
              key: karavan.git.branch
        - name: KARAVAN_DEFAULT_RUNTIME
          value: "camel-k"
        - name: KARAVAN_CONTAINER_STATUS_INTERVAL
          value: "disabled"
        - name: KARAVAN_CONTAINER_STATISTICS_INTERVAL
          value: "disabled"
        - name: KUBERNETES_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: KARAVAN_DEPLOYMENT_NAMESPACES
          value: "camel-k"
        volumeMounts:
        - name: karavan-data
          mountPath: /karavan/data
        livenessProbe:
          tcpSocket:
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          tcpSocket:
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
      volumes:
      - name: karavan-data
        persistentVolumeClaim:
          claimName: karavan-data
