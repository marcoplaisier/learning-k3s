---
- name: Install and Configure ArgoCD
  hosts: k3s_control_plane
  become: yes
  tasks:
    - name: Create ArgoCD namespace
      command: kubectl create namespace argocd
      register: argocd_namespace
      failed_when:
        - argocd_namespace.rc != 0
        - "'AlreadyExists' not in argocd_namespace.stderr"
      changed_when: argocd_namespace.rc == 0

    - name: Install ArgoCD
      command: >
        kubectl apply -n argocd -f
        https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
      register: argocd_install
      changed_when: "'created' in argocd_install.stdout or 'configured' in argocd_install.stdout"

    - name: Wait for ArgoCD server to be ready
      command: kubectl wait --for=condition=available --timeout=300s deployment/argocd-server -n argocd
      register: argocd_ready
      changed_when: false
      retries: 3
      delay: 10
      until: argocd_ready.rc == 0

    - name: Copy ArgoCD ingress manifest to remote host
      copy:
        src: ../manifests/apps/argo-cd/ingress.yaml
        dest: /tmp/argocd-ingress.yaml
        mode: '0644'

    - name: Apply ArgoCD ingress from manifest
      command: kubectl apply -f /tmp/argocd-ingress.yaml
      register: argocd_ingress
      changed_when: "'created' in argocd_ingress.stdout or 'configured' in argocd_ingress.stdout"

    - name: Remove temporary ingress manifest
      file:
        path: /tmp/argocd-ingress.yaml
        state: absent

    - name: Get ArgoCD admin password
      shell: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
      register: argocd_password
      changed_when: false
      failed_when: false

    - name: Display ArgoCD access information
      debug:
        msg:
          - "ArgoCD has been installed successfully!"
          - "Username: admin"
          - "Password: {{ argocd_password.stdout }}"
          - ""
          - "ArgoCD ingress has been configured"
          - ""
          - "To access ArgoCD:"
          - "1. Add '192.168.178.81 argocd.local' to your /etc/hosts file"
          - "2. Access the UI at: http://argocd.homelab.internal"
          - ""
          - "Or use port-forward temporarily:"
          - "kubectl port-forward svc/argocd-server -n argocd 8080:443"
      when: argocd_password.stdout != ""

    - name: Get ArgoCD server status
      command: kubectl get pods -n argocd
      register: argocd_pods
      changed_when: false

    - name: Display ArgoCD pods
      debug:
        var: argocd_pods.stdout_lines
