---
- name: Configure K3s to use insecure in-cluster registry
  hosts: k3s_cluster
  become: yes
  tasks:
    - name: Create /etc/rancher/k3s directory
      file:
        path: /etc/rancher/k3s
        state: directory
        mode: '0755'

    - name: Configure registries.yaml for in-cluster registry
      copy:
        dest: /etc/rancher/k3s/registries.yaml
        content: |
          mirrors:
            "registry.registry:5000":
              endpoint:
                - "http://localhost:30500"
          configs:
            "registry.registry:5000":
              tls:
                insecure_skip_verify: true
        mode: '0644'
      register: registries_config

    - name: Restart K3s on control plane
      systemd:
        name: k3s
        state: restarted
      when:
        - inventory_hostname in groups['k3s_control_plane']
        - registries_config.changed

    - name: Restart K3s agent on workers
      systemd:
        name: k3s-agent
        state: restarted
      when:
        - inventory_hostname in groups['k3s_workers']
        - registries_config.changed

    - name: Wait for K3s to be ready
      wait_for:
        port: 6443
        host: "{{ ansible_host }}"
        delay: 5
        timeout: 60
      when: inventory_hostname in groups['k3s_control_plane']
